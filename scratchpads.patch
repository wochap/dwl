From d23325c13a70510e1bc44e9b0ec37e9aa2780a61 Mon Sep 17 00:00:00 2001
From: wochap <gean.marroquin@gmail.com>
Date: Fri, 5 Apr 2024 14:13:52 -0500
Subject: [PATCH 1/4] implement scratchpads

---
 config.def.h |  2 ++
 dwl.c        | 47 +++++++++++++++++++++++++++++++++++++++++++++++
 2 files changed, 49 insertions(+)

diff --git a/config.def.h b/config.def.h
index db0babc..780aa96 100644
--- a/config.def.h
+++ b/config.def.h
@@ -135,6 +135,8 @@ static const Key keys[] = {
 	{ MODKEY,                    XKB_KEY_space,      setlayout,      {0} },
 	{ MODKEY|WLR_MODIFIER_SHIFT, XKB_KEY_space,      togglefloating, {0} },
 	{ MODKEY,                    XKB_KEY_e,         togglefullscreen, {0} },
+	{ MODKEY,                    XKB_KEY_d,          togglescratchpad, {0} },
+	{ MODKEY|WLR_MODIFIER_SHIFT, XKB_KEY_D,          toggleinscratchpad, {0} },
 	{ MODKEY,                    XKB_KEY_0,          view,           {.ui = ~0} },
 	{ MODKEY|WLR_MODIFIER_SHIFT, XKB_KEY_parenright, tag,            {.ui = ~0} },
 	{ MODKEY,                    XKB_KEY_comma,      focusmon,       {.i = WLR_DIRECTION_LEFT} },
diff --git a/dwl.c b/dwl.c
index ef27a1d..5cb1f3d 100644
--- a/dwl.c
+++ b/dwl.c
@@ -130,6 +130,7 @@ typedef struct {
 	uint32_t tags;
 	int isfloating, isurgent, isfullscreen;
 	uint32_t resize; /* configure serial of a pending resize */
+	int inscratchpad;
 } Client;
 
 typedef struct {
@@ -315,6 +316,8 @@ static void togglefloating(const Arg *arg);
 static void togglefullscreen(const Arg *arg);
 static void toggletag(const Arg *arg);
 static void toggleview(const Arg *arg);
+static void togglescratchpad(const Arg *arg);
+static void toggleinscratchpad(const Arg *arg);
 static void unlocksession(struct wl_listener *listener, void *data);
 static void unmaplayersurfacenotify(struct wl_listener *listener, void *data);
 static void unmapnotify(struct wl_listener *listener, void *data);
@@ -424,6 +427,7 @@ applyrules(Client *c)
 	Monitor *mon = selmon, *m;
 
 	c->isfloating = client_is_float_type(c);
+	c->inscratchpad = 0;
 	if (!(appid = client_get_appid(c)))
 		appid = broken;
 	if (!(title = client_get_title(c)))
@@ -2485,6 +2489,49 @@ toggleview(const Arg *arg)
 	printstatus();
 }
 
+void
+togglescratchpad(const Arg *arg)
+{
+	Client *c;
+	int iscratchpadvisible = 1;
+	int found = 0;
+
+	wl_list_for_each(c, &clients, link) {
+		if (c->inscratchpad) {
+			found = 1;
+			if (!VISIBLEON(c, selmon)) {
+				iscratchpadvisible = 0;
+			}
+		}
+	}
+	if (!found)
+		return;
+	wl_list_for_each(c, &clients, link) {
+		if (c->inscratchpad) {
+			c->tags = iscratchpadvisible ? 0 : selmon->tagset[selmon->seltags];
+			focusclient(c, 1);
+		}
+	}
+	arrange(selmon);
+}
+
+void
+toggleinscratchpad(const Arg *arg)
+{
+	Client *sel = focustop(selmon);
+	if (!sel)
+		return;
+	if (!sel->mon)
+		return;
+	sel->inscratchpad = !sel->inscratchpad;
+	if (sel->inscratchpad) {
+		sel->tags = 0;
+	} else {
+		sel->tags = selmon->tagset[selmon->seltags];
+	}
+	arrange(selmon);
+}
+
 void
 unlocksession(struct wl_listener *listener, void *data)
 {
-- 
2.43.2


From b482d0d5b00c5edb084aba2c7efe5e262fc51ef8 Mon Sep 17 00:00:00 2001
From: wochap <gean.marroquin@gmail.com>
Date: Sat, 6 Apr 2024 08:28:08 -0500
Subject: [PATCH 2/4] focus before moving all to scratchpad

---
 dwl.c | 31 ++++++++++++++++++++++++++++---
 1 file changed, 28 insertions(+), 3 deletions(-)

diff --git a/dwl.c b/dwl.c
index 5cb1f3d..91aeed3 100644
--- a/dwl.c
+++ b/dwl.c
@@ -2493,19 +2493,44 @@ void
 togglescratchpad(const Arg *arg)
 {
 	Client *c;
-	int iscratchpadvisible = 1;
+	Client *sel = focustop(selmon);
+	int iscratchpadvisible;
 	int found = 0;
+	int visible = 0;
+	int focus = 0;
+	int hidden_count = 0;
 
 	wl_list_for_each(c, &clients, link) {
 		if (c->inscratchpad) {
 			found = 1;
+			if (sel == c) {
+				focus = 1;
+			}
+			if (VISIBLEON(c, selmon)) {
+				visible = 1;
+			}
 			if (!VISIBLEON(c, selmon)) {
-				iscratchpadvisible = 0;
+				hidden_count++;
 			}
 		}
 	}
-	if (!found)
+
+	if (!found) {
 		return;
+	}
+
+	if (hidden_count > 0) {
+		iscratchpadvisible = 0;
+	} else if (visible) {
+		if (focus) {
+			iscratchpadvisible = 1;
+		} else {
+			iscratchpadvisible = 0;
+		}
+	} else {
+		iscratchpadvisible = 0;
+	}
+
 	wl_list_for_each(c, &clients, link) {
 		if (c->inscratchpad) {
 			c->tags = iscratchpadvisible ? 0 : selmon->tagset[selmon->seltags];
-- 
2.43.2


From 4ad3b05b29303c3a9a1db5b01514a7f7bb35fc31 Mon Sep 17 00:00:00 2001
From: wochap <gean.marroquin@gmail.com>
Date: Sat, 6 Apr 2024 08:42:20 -0500
Subject: [PATCH 3/4] fix after hiding scratchpad focus is lost

---
 dwl.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/dwl.c b/dwl.c
index 91aeed3..f3aaa80 100644
--- a/dwl.c
+++ b/dwl.c
@@ -2534,7 +2534,7 @@ togglescratchpad(const Arg *arg)
 	wl_list_for_each(c, &clients, link) {
 		if (c->inscratchpad) {
 			c->tags = iscratchpadvisible ? 0 : selmon->tagset[selmon->seltags];
-			focusclient(c, 1);
+			focusclient(c->tags == 0 ? focustop(selmon) : c, 1);
 		}
 	}
 	arrange(selmon);
-- 
2.43.2


From 66cf919262e894ac74a9c476a5893f5bf49a55f4 Mon Sep 17 00:00:00 2001
From: wochap <gean.marroquin@gmail.com>
Date: Mon, 8 Apr 2024 19:35:21 -0500
Subject: [PATCH 4/4] fix: when using more than 1 monitor, scratch doesn't move
 to monitor in focus

---
 dwl.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/dwl.c b/dwl.c
index f3aaa80..ed1b6e7 100644
--- a/dwl.c
+++ b/dwl.c
@@ -2534,6 +2534,9 @@ togglescratchpad(const Arg *arg)
 	wl_list_for_each(c, &clients, link) {
 		if (c->inscratchpad) {
 			c->tags = iscratchpadvisible ? 0 : selmon->tagset[selmon->seltags];
+			if (c->tags != 0 && c->mon != selmon) {
+				setmon(c, selmon, 0);
+			}
 			focusclient(c->tags == 0 ? focustop(selmon) : c, 1);
 		}
 	}
-- 
2.43.2

